---
name: <%= product_name %>
product_version: <%= product_version %>
label: Weaveworks
description: Weaveworks Stuff
icon_image: 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
metadata_version: '1.9'
minimum_version_for_upgrade: '0.0.1'
rank: 1
serial: true

provides_product_versions:
- name: <%= product_name %>
  version: <%= product_version %>

releases:
- name: <%= releases['weave-scope'].name %>
  file: <%= releases['weave-scope'].file %>
  version: <%= releases['weave-scope'].version %>
- name: <%= releases['runtime-configurator'].name %>
  file: <%= releases['runtime-configurator'].file %>
  version: <%= releases['runtime-configurator'].version %>
- name: <%= releases['uaa-proxy'].name %>
  file: <%= releases['uaa-proxy'].file %>
  version: <%= releases['uaa-proxy'].version %>
- name: <%= releases['consul'].name %>
  file: <%= releases['consul'].file %>
  version: <%= releases['consul'].version %>
- name: <%= releases['routing'].name %>
  file: <%= releases['routing'].file %>
  version: <%= releases['routing'].version %>

stemcell_criteria:
  os: ubuntu-trusty
  requires_cpi: false
  version: <%= stemcell_version %>

property_blueprints:
- name: weave_cloud_token
  type: string
  configurable: true
  optional: true

form_types:
- name: explore
  label: Explore
  description: View, control, and troubleshoot your deployments using Weave Scope
  property_inputs:
  - reference: ".properties.weave_cloud_token"
    label: Weave Cloud Service Token
    description: |
      Specifying this token allows you send Scope reports from your BOSH
      deployments to your cloud.weave.works account. Optional.

job_types:
- name: scope-app
  resource_label: Weave Scope App
  templates:
  - name: scope_app
    release: <%= releases['weave-scope'].name %>
    provides: |
      weave_scope_app:
        as: weave_scope_app
        shared: true
  - name: uaaproxy
    release: <%= releases['uaa-proxy'].name %>
  - name: consul_agent
    release: <%= releases['consul'].name %>
    consumes: |
      consul_common:
        from: consul_common_link
        deployment: (( ..cf.deployment_name ))
      consul_client:
        from: consul_client_link
        deployment: (( ..cf.deployment_name ))
      consul_server: nil
  - name: route_registrar
    release: <%= releases['routing'].name %>
    consumes: |
      nats:
        from: nats
        deployment: (( ..cf.deployment_name ))
  resource_definitions:
  - name: ram
    type: integer
    configurable: true
    default: 1024
    constraints:
      min: 512
      may_only_increase: false
  - name: ephemeral_disk
    type: integer
    configurable: true
    default: 512
    constraints:
      min: 512
  - name: persistent_disk
    type: integer
    configurable: false
    default: 0
  - name: cpu
    type: integer
    configurable: true
    default: 2
    constraints:
      min: 1
  static_ip: 1
  dynamic_ip: 0
  max_in_flight: 1
  single_az_only: false
  instance_definition:
    name: instances
    configurable: true
    default: 1
  property_blueprints:
  - name: uaaproxy_session_auth_key
    type: secret
    label: "Session Authentication Key"
  - name: uaaproxy_session_encrypt_key
    type: secret
    label: "Session Encryption Key"
  - name: uaaproxy_proxy_client_creds
    type: simple_credentials
    default:
      identity: weave_scope
    label: "UAA Proxy Client Secret"
  manifest: |
    ---
    uaaproxy:
      listen_address: ":8080"
      backend_address: "http://localhost:4040"
      session:
        auth_key: "(( uaaproxy_session_auth_key.value ))"
        encrypt_key: "(( uaaproxy_session_encrypt_key.value ))"
      redirect:
        port: "(( ..cf.properties.logger_endpoint_port.value ))"
        protocol: "https"
      uaa:
        url: "https://uaa.(( ..cf.cloud_controller.system_domain.value ))"
        internal_url: "https://uaa.service.cf.internal:8443"
        required_scopes:
        - "cloud_controller.admin"
        token_ttl: "2m"
        proxy_client:
          name: "Weave Scope"
          id: "(( uaaproxy_proxy_client_creds.identity ))"
          secret: "((  uaaproxy_proxy_client_creds.password ))"
          redirect_url: "https://scope.(( ..cf.cloud_controller.system_domain.value ))/auth/callback"
        register_proxy_client: true
        admin_client:
          id: "(( ..cf.uaa.admin_client_credentials.identity ))"
          secret: "(( ..cf.uaa.admin_client_credentials.password ))"
        ca_cert: "(( $ops_manager.ca_certificate ))"
    route_registrar:
      routes:
      - name: scope
        port: 8080
        registration_interval: 20s
        tags:
          component: "scope"
        uris:
        - "scope.(( ..cf.cloud_controller.system_domain.value ))"

- name: add-probe
  resource_label: Install Scope Probe
  templates:
  - name: configurator
    release: <%= releases['runtime-configurator'].name %>
  errand: true
  resource_definitions:
  - name: ram
    type: integer
    label: RAM
    configurable: false
    default: 512
    constraints:
      min: 512
  - name: ephemeral_disk
    type: integer
    label: Ephemeral Disk
    configurable: false
    default: 512
    constraints:
      min: 512
  - name: persistent_disk
    type: integer
    label: Persistent Disk
    configurable: false
    default: 0
  - name: cpu
    type: integer
    label: CPU
    configurable: false
    default: 1
    constraints:
      min: 1
  static_ip: 0
  dynamic_ip: 1
  max_in_flight: 1
  single_az_only: false
  instance_definition:
    name: instances
    configurable: false
    default: 1
  property_blueprints: []
  manifest: |
    ---
    runtime_configurator:
      bosh:
        url: https://(( $director.hostname )):25555
        user: (( $director.username ))
        password: (( $director.password ))
        ca_cert: (( $director.ca_public_key ))
      uaa:
        url: https://(( $director.hostname )):8443
      deploy: true
      add:
        releases:
        - name: <%= releases['weave-scope'].name %>
          version: <%= releases['weave-scope'].version %>
        addons:
        - name: scope-probe
          include:
            deployments:
            - (( ..cf.deployment_name ))
            - (( .deployment_name ))
          jobs:
          - name: scope_probe
            release: <%= releases['weave-scope'].name %>
            consumes:
              weave_scope_app:
                from: weave_scope_app
                deployment: (( .deployment_name ))
            properties:
              weave:
                scope:
                  probe:
                    service_token: "(( .properties.weave_cloud_token.value ))"
        - name: scope-garden
          include:
            deployments:
            - (( ..cf.deployment_name ))
            jobs:
            - name: garden
              release: garden-runc
          jobs:
          - name: scope_garden
            release: weave-scope
            properties:
              weave:
                scope:
                  probe:
                    garden:
                      network: unix
                      addr: /var/vcap/data/garden/garden.sock
                    cf:
                      api_url: "(( $runtime.system_api_url ))"
                      username: (( ..cf.uaa.system_services_credentials.identity ))
                      password: (( ..cf.uaa.system_services_credentials.password ))
                      skip_ssl_verify: true

- name: remove-probe
  resource_label: Uninstall Scope Probe
  templates:
  - name: configurator
    release: <%= releases['runtime-configurator'].name %>
  errand: true
  resource_definitions:
  - name: ram
    type: integer
    label: RAM
    configurable: false
    default: 512
    constraints:
      min: 512
  - name: ephemeral_disk
    type: integer
    label: Ephemeral Disk
    configurable: false
    default: 512
    constraints:
      min: 512
  - name: persistent_disk
    type: integer
    label: Persistent Disk
    configurable: false
    default: 0
  - name: cpu
    type: integer
    label: CPU
    configurable: false
    default: 1
    constraints:
      min: 1
  static_ip: 0
  dynamic_ip: 1
  max_in_flight: 1
  single_az_only: false
  instance_definition:
    name: instances
    configurable: false
    default: 1
  property_blueprints: []
  manifest: |
    ---
    runtime_configurator:
      bosh:
        url: https://(( $director.hostname )):25555
        user: (( $director.username ))
        password: (( $director.password ))
        ca_cert: (( $director.ca_public_key ))
      uaa:
        url: https://(( $director.hostname )):8443
      deploy: true
      remove:
        releases:
        - name: <%= releases['weave-scope'].name %>
        addons:
        - name: scope-probe
        - name: scope-garden

post_deploy_errands:
- name: add-probe

pre_delete_errands:
- name: remove-probe

update:
  canaries: 1
  canary_watch_time: 10000-100000
  max_in_flight: 1
  update_watch_time: 10000-100000
